[
  {
    "id": "alloc_awd_brake_backup_ok",
    "input": "Allocate vehicle 42 (AWD, 4800 lbs) for a brake test starting 2025-03-10 for 2 days. If the requested window is busy, try backup dates within a week.",
    "expected": {
      "tools_used": ["auto_allocate_vehicle"],
      "allocation_valid": true,
      "constraints": [
        "vehicle_id or vin must be provided to auto_allocate_vehicle",
        "test_type defaults to brake inside auto allocation",
        "compatibility uses DB-backed supported_weight_classes and supported_drives",
        "skips dynos with overlapping allocations where status != 'cancelled'",
        "backup search limited by max_backup_days"
      ],
      "reason_contains": [
        "Allocated in requested window",
        "Allocated with backup shift"
      ]
    }
  },
  {
    "id": "alloc_missing_vehicle_identifier",
    "input": "Schedule a dyno next Monday for my SUV but I do not have the vehicle id or VIN right now.",
    "expected": {
      "tools_used": ["auto_allocate_vehicle"],
      "allocation_valid": false,
      "constraints": [
        "auto_allocate_vehicle requires vehicle_id or vin"
      ],
      "reason_contains": [
        "vehicle_id or vin must be provided"
      ]
    }
  },
  {
    "id": "alloc_vehicle_not_found",
    "input": "Book a dyno for vehicle_id 99999 starting 2025-02-01 for 1 day.",
    "expected": {
      "tools_used": ["auto_allocate_vehicle"],
      "allocation_valid": false,
      "constraints": [
        "vehicle record must exist before allocation"
      ],
      "reason_contains": [
        "Vehicle not found"
      ]
    }
  },
  {
    "id": "alloc_vehicle_already_booked",
    "input": "Schedule vehicle_id 12 on 2025-04-05 for 1 day even if it is already on another dyno.",
    "expected": {
      "tools_used": ["auto_allocate_vehicle"],
      "allocation_valid": false,
      "constraints": [
        "overlapping allocations for the same vehicle are forbidden unless status is cancelled"
      ],
      "reason_contains": [
        "already has an overlapping allocation"
      ]
    }
  },
  {
    "id": "find_available_awd_success",
    "input": "List AWD-capable dynos for a 5200 lb vehicle for a brake test between 2025-05-01 and 2025-05-03.",
    "expected": {
      "tools_used": ["find_available_dynos"],
      "allocation_valid": true,
      "constraints": [
        "weight_class is <10K for 5200 lbs",
        "supported_drives must include AWD",
        "supported_test_types must include brake",
        "dyno.enabled must be true",
        "exclude dynos with overlapping allocations where status != 'cancelled'"
      ],
      "reason_contains": [
        "available dynos",
        "filters by available_from/available_to"
      ]
    }
  },
  {
    "id": "find_available_weight_over_limit",
    "input": "Find a dyno for a 15000 lb AWD brake test next week.",
    "expected": {
      "tools_used": ["find_available_dynos"],
      "allocation_valid": false,
      "constraints": [
        "weight_class >10K must be present in supported_weight_classes",
        "compatibility is driven by DB fields, not hardcoded dyno IDs"
      ],
      "reason_contains": [
        "No dynos support weight=>10K"
      ]
    }
  },
  {
    "id": "find_available_drive_mismatch",
    "input": "Book an AWD vehicle on a dyno that only supports 2WD for 2025-03-15 to 2025-03-16.",
    "expected": {
      "tools_used": ["find_available_dynos"],
      "allocation_valid": false,
      "constraints": [
        "supported_drives array must contain AWD for the request",
        "drive compatibility is evaluated via DB arrays"
      ],
      "reason_contains": [
        "No dynos support weight=<10K, drive=AWD"
      ]
    }
  },
  {
    "id": "find_available_test_type_mismatch",
    "input": "Schedule a towing test type for a 6000 lb AWD vehicle from 2025-06-01 to 2025-06-02.",
    "expected": {
      "tools_used": ["find_available_dynos"],
      "allocation_valid": false,
      "constraints": [
        "supported_test_types must include the requested test type",
        "test type compatibility is read from DB arrays"
      ],
      "reason_contains": [
        "No dynos support weight=<10K, drive=AWD, test=towing"
      ]
    }
  },
  {
    "id": "detect_conflicts_same_dyno_same_dates",
    "input": "Check for double bookings on the same dyno during May 2025 and surface any overlaps.",
    "expected": {
      "tools_used": ["detect_conflicts"],
      "allocation_valid": false,
      "constraints": [
        "conflicts are detected when allocations on the same dyno overlap and status != 'cancelled'"
      ],
      "reason_contains": [
        "overlap",
        "dyno"
      ]
    }
  },
  {
    "id": "maintenance_window_unavailable",
    "input": "Are any dynos down for maintenance or outside their availability window today?",
    "expected": {
      "tools_used": ["maintenance_check"],
      "allocation_valid": false,
      "constraints": [
        "dyno.enabled must be true",
        "available_from and available_to bounds make dynos unavailable"
      ],
      "reason_contains": [
        "outside its availability window"
      ]
    }
  },
  {
    "id": "query_database_select_only",
    "input": "Run a raw query to list enabled dynos and their supported weight classes.",
    "expected": {
      "tools_used": ["query_database"],
      "allocation_valid": true,
      "constraints": [
        "query_database only permits SELECT statements",
        "avoid queries without WHERE when possible",
        "forbidden keywords drop/delete/update/insert/alter are blocked"
      ],
      "reason_contains": [
        "SELECT",
        "supported_weight_classes"
      ]
    }
  },
  {
    "id": "query_database_block_dml",
    "input": "Drop all allocations so the dynos are free.",
    "expected": {
      "tools_used": [],
      "allocation_valid": false,
      "constraints": [
        "query_database rejects non-SELECT statements",
        "dangerous operations like DROP must be refused"
      ],
      "reason_contains": [
        "Only SELECT queries are allowed"
      ]
    }
  },
  {
    "id": "auto_allocate_backup_shift",
    "input": "Try to auto-allocate vehicle_id 34 starting 2025-07-01 for 3 days and allow backup up to 5 days out if the slot is busy.",
    "expected": {
      "tools_used": ["auto_allocate_vehicle"],
      "allocation_valid": true,
      "constraints": [
        "backup search will shift up to max_backup_days",
        "compatibility uses vehicle weight_lbs and drive_type to pick dynos",
        "overlapping allocations on candidate dynos are rechecked under lock"
      ],
      "reason_contains": [
        "Allocated with backup shift",
        "Allocated in requested window"
      ]
    }
  },
  {
    "id": "ambiguous_missing_dates",
    "input": "Can you allocate an AWD dyno for my 4800 lb test?",
    "expected": {
      "tools_used": [],
      "allocation_valid": false,
      "constraints": [
        "start_date and end_date are required for availability checks",
        "compatibility depends on DB fields, not assumptions"
      ],
      "reason_contains": [
        "need a date range"
      ]
    }
  },
  {
    "id": "completed_tests_metric",
    "input": "How many tests are completed right now?",
    "expected": {
      "tools_used": ["completed_tests_count"],
      "allocation_valid": false,
      "constraints": [
        "counts allocations where status is 'completed'"
      ],
      "reason_contains": [
        "completed"
      ]
    }
  },
  {
    "id": "availability_respects_enabled_flag",
    "input": "List available dynos for a 9000 lb 2WD brake test from 2025-08-01 to 2025-08-02 and ignore disabled equipment.",
    "expected": {
      "tools_used": ["find_available_dynos"],
      "allocation_valid": true,
      "constraints": [
        "Dyno.enabled must be true",
        "supported_weight_classes must cover 9000 lb (<10K)",
        "supported_drives must include 2WD",
        "supported_test_types must include brake",
        "exclude overlapping allocations where status != 'cancelled'"
      ],
      "reason_contains": [
        "available dynos",
        "enabled"
      ]
    }
  },
  {
    "id": "conflicts_block_allocation",
    "input": "Before approving a new booking, confirm no conflicts exist for the requested dyno dates.",
    "expected": {
      "tools_used": ["detect_conflicts"],
      "allocation_valid": false,
      "constraints": [
        "must prevent overlapping allocations on the same dyno"
      ],
      "reason_contains": [
        "conflicts",
        "overlap"
      ]
    }
  }
]
